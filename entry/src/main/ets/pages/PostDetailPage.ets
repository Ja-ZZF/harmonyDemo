import { PostComment } from '../components/PostComment';
import { PostAppBar } from '../components/PostAppBar';
import { PostBottomBar} from '../components/PostBottomBar'
import { CommentSimple } from '../models/Comment';
import { createEmptyPostDetail, PostDetail } from '../models/Post';
import { createEmptyUserSimple, UserSimple } from '../models/User';
import { PostService } from '../services/post.service'
import { PostImageCarousel } from '../components/PostImageCarousel';
import { PostContent } from '../components/PostContent';
import { PostCommentNew } from '../components/PostCommentNew';
import { eventBus, EventPayload } from '../commons/utils/EventBus';
import { convertMediaUrls } from '../commons/utils/MediaUtils';


@Entry
@Component
struct PostDetailPage {
  private postService = new PostService();

  private postId: number = 1;              // å‡è®¾æ˜¯ä»å¤–éƒ¨ä¼ å…¥çš„ post_id

  @State postDetail: PostDetail = createEmptyPostDetail();

  async aboutToAppear(): Promise<void> {
    this.postDetail = await this.postService.getPostDetail(this.postId);

    eventBus.on('refreshPostComments', (payload: EventPayload) => {
      if (payload.type === 'refresh' && Number(payload.data) === this.postId) {
        this.refreshComments();
      }
    });

  }

  async refreshComments(): Promise<void> {
    console.info('æ­£åœ¨åˆ·æ–°è¯„è®º...');
    const detail = await this.postService.getPostDetail(this.postId);
    this.postDetail.comments = detail.comments;
    this.postDetail.comment_count = detail.comment_count;
  }


  build() {
    Flex({ direction: FlexDirection.Column }) // ğŸ’¡ ç”¨ Flex æ’‘æ»¡å±å¹•
    {
      // é¡¶éƒ¨ AppBar
      PostAppBar({ user: this.postDetail.post_simple.publisher })
      // ä¸­é—´ Scroll æ’‘æ»¡å‰©ä½™ç©ºé—´
      Scroll()
      {
        Column({ space: 12 }) {
          //å›¾ç‰‡
          PostImageCarousel({ medias: convertMediaUrls(this.postDetail.medias,'medium') })

          //æ­£æ–‡
          PostContent({
            title: this.postDetail.post_simple.title,
            content: this.postDetail.content,
            tags: this.postDetail.tags,
            publish_time : this.postDetail.publish_time,
          })

          //åˆ†å‰²çº¿
          Shape()
            .height(1)
            .width('100%')
            .backgroundColor('#EEEEEE')
            .margin({top:8,bottom:8})

          //è¯„è®ºæ€»æ•°æç¤º
          Text('å…± '+this.postDetail.comment_count.toString()+' æ¡è¯„è®º')
            .textAlign(TextAlign.Start)
            .width('100%')
          //è¯„è®ºåŒº
          ForEach(this.postDetail.comments, (comment: CommentSimple) => {
            PostCommentNew({ comment: comment })
          }, (comment: CommentSimple) => comment.comment_id.toString())
        }
        .padding({ left: 8, right: 8, bottom: 80 }) // ç•™å‡ºåº•éƒ¨æ é«˜åº¦
        .width('100%')
      }
      .flexGrow(1) // ğŸ’¡ å…³é”®
      .width('100%')
      // åº•éƒ¨å›ºå®šæ 
      PostBottomBar({
        comment_count: this.postDetail.comment_count,
        likeStats: this.postDetail.post_simple.like_stats,
        collectStats: this.postDetail.collect_stats,
        postId : this.postDetail.post_simple.post_id,
      })
        .width('100%')
        //.height(56) // ğŸ’¡ è®¾ç½®å›ºå®šé«˜åº¦
    }
    .width('100%')
    .height('100%')
  }
}

