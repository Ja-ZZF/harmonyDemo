import { PostAppBar } from '../components/PostAppBar';
import { PostBottomBar} from '../components/PostBottomBar'
import { CommentSimple } from '../models/Comment';
import { createEmptyPostDetail, PostDetail, PostDetailParams } from '../models/Post';
import { PostService } from '../services/post.service'
import { PostImageCarousel } from '../components/PostImageCarousel';
import { PostContent } from '../components/PostContent';
import { PostCommentNew } from '../components/PostCommentNew';
import { eventBus, EventPayload } from '../commons/utils/EventBus';
import { convertMediaUrls } from '../commons/utils/MediaUtils';
import { router } from '@kit.ArkUI';
import { getHeight } from '../commons/utils/imageHandler';
import { PostImageGrid } from '../components/PostImageGrid';


@Entry
@Component
struct PostDetailPage {
  private postService = new PostService();

  private postId: number = 1;              // å‡è®¾æ˜¯ä»å¤–éƒ¨ä¼ å…¥çš„ post_id

  @State postDetail: PostDetail = createEmptyPostDetail();

  @State imageShowingState : boolean = false;


  async aboutToAppear(): Promise<void> {
    const params = router.getParams() as PostDetailParams; //æå–å‚æ•°
    this.postId = params.postId ?? 0; //æå–id
    this.postDetail = await this.postService.getPostDetail(this.postId); //æå–ç¬”è®°è¯¦æƒ…

    eventBus.on('refreshPostComments', async (payload: EventPayload) => {
      if (payload.type === 'refresh' && Number(payload.data) === this.postId) {
        console.info('åˆ·æ–°');
        //await this.refreshComments();
        await this.refreshDetails();
      }
    });

  }

  async refreshComments(): Promise<void> {
    console.info('æ­£åœ¨åˆ·æ–°è¯„è®º...');
    const detail = await this.postService.getPostDetail(this.postId);
    this.postDetail.comments = detail.comments;
    this.postDetail.comment_count = detail.comment_count;
  }

  async refreshDetails() : Promise<void>{
    console.info('æ­£åœ¨åˆ·æ–°å…¨éƒ¨...');
    const newDetail = await this.postService.getPostDetail(this.postId);

    this.postDetail = {
      post_simple : newDetail.post_simple,
      content : newDetail.content,
      medias : newDetail.medias,
      permission : newDetail.permission,
      publish_time : newDetail.publish_time,
      collect_stats : newDetail.collect_stats,
      browse_count : newDetail.browse_count,
      comment_count : newDetail.comment_count,
      tags : newDetail.tags,
      comments : newDetail.comments,
    }

    console.info('å…¨éƒ¨è¯„è®ºï¼š',JSON.stringify(this.postDetail.comments));
  }


  build() {
    Flex({ direction: FlexDirection.Column }) // ğŸ’¡ ç”¨ Flex æ’‘æ»¡å±å¹•
    {
      // é¡¶éƒ¨ AppBar
      PostAppBar({ user: this.postDetail.post_simple.publisher })
      // ä¸­é—´ Scroll æ’‘æ»¡å‰©ä½™ç©ºé—´
      Scroll()
      {
        Column({ space: 12 }) {

          //å›¾ç‰‡åŒºåŸŸ
          Column() {
            if(this.imageShowingState){
              Column() {
                PostImageGrid({medias: convertMediaUrls(this.postDetail.medias, 'medium') })
              }
                .align(Alignment.TopStart)
                .width('90%')
                .height(getHeight(this.postDetail.medias.length))
                .transition(TransitionEffect.OPACITY.animation({ duration: 1500, curve: Curve.Ease })
                  .combine(TransitionEffect.scale({x:0.5,y:0.5})))
            }else {
              //å›¾ç‰‡
              PostImageCarousel({ medias: convertMediaUrls(this.postDetail.medias, 'medium'),cover_url : this.postDetail.post_simple.cover_url})
                .transition(TransitionEffect.OPACITY.animation({ duration: 1500, curve: Curve.Ease })
                  .combine(TransitionEffect.scale({x:0.5,y:0.5})))
            }
          }
          .width('100%')
          .gesture(
            TapGesture({ count: 2 })
              .onAction((event: GestureEvent) => {
                if (event) {
                  this.imageShowingState = !this.imageShowingState;
                }
              }))

          //æ­£æ–‡
          PostContent({
            title: this.postDetail.post_simple.title,
            content: this.postDetail.content,
            tags: this.postDetail.tags,
            publish_time : this.postDetail.publish_time,
          })

          //åˆ†å‰²çº¿
          Shape()
            .height(1)
            .width('100%')
            .backgroundColor('#EEEEEE')
            .margin({top:8,bottom:8})

          // æ‚¬æµ®å›ºå®šæ 
          if(this.imageShowingState) {
            PostBottomBar({
              comment_count: this.postDetail.comment_count,
              likeStats: this.postDetail.post_simple.like_stats,
              collectStats: this.postDetail.collect_stats,
              postId: this.postDetail.post_simple.post_id,
            })
              .width('100%')
          }

          //è¯„è®ºæ€»æ•°æç¤º
          Text('å…± '+this.postDetail.comment_count.toString()+' æ¡è¯„è®º')
            .textAlign(TextAlign.Start)
            .width('100%')
          //è¯„è®ºåŒº
          ForEach(this.postDetail.comments, (comment: CommentSimple) => {
            PostCommentNew({ comment: comment })
          }, (comment: CommentSimple) => comment.comment_id.toString())
          //å¦‚æœè¯„è®ºä¸ºç©º
          if(this.postDetail.comment_count === 0){
            Image($r('app.media.write'))
              .width('15%')
              .margin({top:12})
            Text('è¯„è®ºç©ºç©ºå¦‚ä¹Ÿ')
              .fontSize(12)
              .fontWeight(FontWeight.Lighter)
              .fontStyle(FontStyle.Italic)
          }

        }
        .padding({ left: 8, right: 8, bottom: 8}) // ç•™å‡ºåº•éƒ¨æ é«˜åº¦
        .width('100%')
      }
      .width('100%')

      // åº•éƒ¨å›ºå®šæ 
      if(!this.imageShowingState) {
        PostBottomBar({
          comment_count: this.postDetail.comment_count,
          likeStats: this.postDetail.post_simple.like_stats,
          collectStats: this.postDetail.collect_stats,
          postId: this.postDetail.post_simple.post_id,
        })
          .width('100%')
      }

    }
    .width('100%')
    .height('100%')
  }
}

